
{% extends 'base.html' %} {% load static %} 
{% block css %}
<style type="text/css">
    .container{max-width:1170px; margin:auto;}
  img{ max-width:100%;}
  .inbox_people {
    background: #f8f8f8 none repeat scroll 0 0;
    float: left;
    overflow: hidden;
    width: 40%; border-right:1px solid #c4c4c4;
  }
  .inbox_msg {
    border: 1px solid #c4c4c4;
    clear: both;
    overflow: hidden;
  }
  .top_spac{ margin: 20px 0 0;}
  
  
  .recent_heading {float: left; width:40%;}
  .srch_bar {
    display: inline-block;
    text-align: right;
    width: 60%; padding:
  }
  .headind_srch{ padding:10px 29px 10px 20px; overflow:hidden; border-bottom:1px solid #c4c4c4;}
  
  .recent_heading h4 {
    color: #05728f;
    font-size: 21px;
    margin: auto;
  }
  .srch_bar input{ border:1px solid #cdcdcd; border-width:0 0 1px 0; width:80%; padding:2px 0 4px 6px; background:none;}
  .srch_bar .input-group-addon button {
    background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
    border: medium none;
    padding: 0;
    color: #707070;
    font-size: 18px;
  }
  .srch_bar .input-group-addon { margin: 0 0 0 -27px;}
  
  .chat_ib h5{ font-size:15px; color:#464646; margin:0 0 8px 0;}
  .chat_ib h5 span{ font-size:13px; float:right;}
  .chat_ib p{ font-size:14px; color:#989898; margin:auto}
  .chat_img {
    float: left;
    width: 11%;
  }
  .chat_ib {
    float: left;
    padding: 0 0 0 15px;
    width: 88%;
  }
  
  .chat_people{ overflow:hidden; clear:both;}
  .chat_list {
    border-bottom: 1px solid #c4c4c4;
    margin: 0;
    padding: 18px 16px 10px;
  }
  .inbox_chat { height: 480px; overflow-y: scroll;}
  
  .active_chat{ background:#ebebeb;}
  
  .incoming_msg_img {
    display: inline-block;
    width: 6%;
  }
  .received_msg {
    display: inline-block;
    padding: 0 0 0 10px;
    vertical-align: top;
    width: 92%;
   }
   .received_withd_msg p {
    background: #ebebeb none repeat scroll 0 0;
    border-radius: 3px;
    color: #646464;
    font-size: 14px;
    margin: 0;
    padding: 5px 10px 5px 12px;
    width: 100%;
  }
  .time_date {
    color: #747474;
    display: block;
    font-size: 12px;
    margin: 8px 0 0;
  }
  .received_withd_msg { width: 57%;}
  .mesgs {
    float: left;
    padding: 30px 15px 0 25px;
    width: 60%;
  }
  
   .sent_msg p {
    background: #05728f none repeat scroll 0 0;
    border-radius: 3px;
    font-size: 14px;
    margin: 0; color:#fff;
    padding: 5px 10px 5px 12px;
    width:100%;
  }
  .outgoing_msg{ overflow:hidden; margin:26px 0 26px;}
  .sent_msg {
    float: right;
    width: 46%;
  }
  .input_msg_write input {
    background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
    border: medium none;
    color: #4c4c4c;
    font-size: 15px;
    min-height: 48px;
    width: 100%;
  }
  
  .type_msg {border-top: 1px solid #c4c4c4;position: relative;}
  .msg_send_btn {
    background: #05728f none repeat scroll 0 0;
    border: medium none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    font-size: 17px;
    height: 33px;
    position: absolute;
    right: 0;
    top: 11px;
    width: 33px;
  }
  .messaging { padding: 0 0 50px 0;}
  .msg_history {
    height: 440px;
    overflow-y: auto;
  }
  </style>
{% endblock %}
{% block content %}
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        Chat 
        <small>Chat</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Calendar</li>
      </ol>
    </section>
    <!-- Main content -->
    <section class="content">
        <div class="row">
        <div class="col-md-1">
            <!-- <div class="box box-warning direct-chat direct-chat-warning" style="min-height: 70vh;"> -->
            <!-- <div class="box-header with-border">
                <h3 class="box-title">Student List</h3>

               
              </div> -->
              <!-- <div class="box-body" >
                <ul class="products-list product-list-in-box">
                    
                    {% for room in all_rooms %}
                        {% if logged_user.username == room.user1.username %}
                            <li class="item">
                              <div class="product-img">
                                <img src="{{MEDIA_URL}}{{request.user.avatar}}" alt="user Image" class="img-circle">
                              </div>
                              <div class="product-info">
                                <a id="room-name-submit" href="/chatapp/{{room.name}}/" class="product-title">{{room.user2.username}}
                                    
                                  </a>
                                  <br>
                                  <span>2 unread message</span>
                                
                              </div>
                            </li>
                        
                        {% elif logged_user.username != room.user1.username %}
                            <li class="item">
                              <div class="product-img">
                                <img src="{{MEDIA_URL}}{{request.user.avatar}}" alt="user Image" class="img-circle">
                              </div>
                              <div class="product-info">
                                <a id="room-name-submit" href="/chatapp/{{room.name}}/" class="product-title">{{room.user1.username}}
                                    
                                  </a>
                                  <br>
                                  <span>2 unread message</span>
                                
                              </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                   
                  </ul>
              </div> -->
            <!-- </div> -->
        </div>
        <div class="col-md-10">
            <!-- DIRECT CHAT -->
            <div class="box box-warning direct-chat direct-chat-warning" style="min-height: 70vh;">
              <div class="box-header with-border">
                <h3 class="box-title">Direct Chat</h3>

                
              </div>
              <!-- /.box-header -->
              <div class="box-body">
                <!-- Conversations are loaded here -->
                <div class="direct-chat-messages">
                    {% for chat in chats %}

                        {% if logged_user == chat.from_user %}
                          <!-- Message to the right -->
                          <div class="direct-chat-msg right">
                            <div class="direct-chat-info clearfix">
                              <span class="direct-chat-name pull-right">{{chat.from_user}}</span>
                              <span class="direct-chat-timestamp pull-left">{{chat.timestamp}}</span>
                            </div>
                            <!-- /.direct-chat-info -->
                            <img class="direct-chat-img" src="{{MEDIA_URL}}{{request.user.avatar}}" alt="image">
                            <!-- /.direct-chat-img -->
                            <div class="direct-chat-text">
                              {{chat.message}}
                            </div>
                            <!-- /.direct-chat-text -->
                          </div>
                          <!-- /.direct-chat-msg -->
                        {% else %} 
                          <!-- Message. Default to the left -->
                          <div class="direct-chat-msg">
                            <div class="direct-chat-info clearfix">
                              <span class="direct-chat-name pull-left">{{chat.from_user}}</span>
                              <span class="direct-chat-timestamp pull-right">{{chat.timestamp}}</span>
                            </div>
                            <!-- /.direct-chat-info -->
                            <img class="direct-chat-img" src="{{MEDIA_URL}}{{request.user.avatar}}" alt="image">
                            <!-- /.direct-chat-img -->
                            <div class="direct-chat-text">
                                {{chat.message}} 
                            </div>
                            <!-- /.direct-chat-text -->
                          </div>
                          <!-- /.direct-chat-msg -->
                        {% endif %}
                  {% endfor %}

                  <div id="chat-box">
                      
                  </div>

                   <!-- Message to the right -->
                    <!-- <div class="direct-chat-msg right" id="right-div">
                    </div> -->
                    <!-- /.direct-chat-msg --> 
                    <!-- Message to the left -->
                    <!-- <div class="direct-chat-msg" id="left-div">
                    </div> -->
                    <!-- /.direct-chat-msg -->     
                </div>
                <!--/.direct-chat-messages-->

                <!-- Contacts are loaded here -->
                <div class="direct-chat-contacts">
                  <ul class="contacts-list">
                    <li>
                      <a href="#">
                        <img class="contacts-list-img" src="{{request.user.avatar}}" alt="User Image">

                        <div class="contacts-list-info">
                              <span class="contacts-list-name">
                                Count Dracula
                                <small class="contacts-list-date pull-right">2/28/2015</small>
                              </span>
                          <span class="contacts-list-msg">How have you been? I was...</span>
                        </div>
                        <!-- /.contacts-list-info -->
                      </a>
                    </li>
                    <!-- End Contact Item -->
                    <li>
                      <a href="#">
                        <img class="contacts-list-img" src="{{request.user.avatar}}" alt="User Image">

                        <div class="contacts-list-info">
                              <span class="contacts-list-name">
                                Sarah Doe
                                <small class="contacts-list-date pull-right">2/23/2015</small>
                              </span>
                          <span class="contacts-list-msg">I will be waiting for...</span>
                        </div>
                        <!-- /.contacts-list-info -->
                      </a>
                    </li>
                    <!-- End Contact Item -->
                    <li>
                      <a href="#">
                        <img class="contacts-list-img" src="{{request.user.avatar}}" alt="User Image">

                        <div class="contacts-list-info">
                              <span class="contacts-list-name">
                                Nadia Jolie
                                <small class="contacts-list-date pull-right">2/20/2015</small>
                              </span>
                          <span class="contacts-list-msg">I'll call you back at...</span>
                        </div>
                        <!-- /.contacts-list-info -->
                      </a>
                    </li>
                    <!-- End Contact Item -->
                    <li>
                      <a href="#">
                        <img class="contacts-list-img" src="{{request.user.avatar}}" alt="User Image">

                        <div class="contacts-list-info">
                              <span class="contacts-list-name">
                                Nora S. Vans
                                <small class="contacts-list-date pull-right">2/10/2015</small>
                              </span>
                          <span class="contacts-list-msg">Where is your new...</span>
                        </div>
                        <!-- /.contacts-list-info -->
                      </a>
                    </li>
                   
                    <!-- End Contact Item -->
                  </ul>
                  <!-- /.contatcts-list -->
                </div>
                <!-- /.direct-chat-pane -->
              </div>
              <!-- /.box-body -->
              <!-- <textarea id="chat-log" cols="100" rows="5">
                  {% for chat in chats %}
                    {{chat.message}}
                    from_user : {{chat.from_user}}
                    to_user : {{chat.to_user}}
                    time_stamp : {{chat.timestamp}}
                {% endfor %}
              </textarea><br> -->
              <div class="box-footer">
                <!-- <form action="#" method="post"> -->
                  <div class="input-group">
                    <input id="chat-message-input" type="text" name="message" placeholder="Type Message ..." class="form-control">
                    <span class="input-group-btn">
                          <button id="chat-message-submit" type="button" class="btn btn-warning btn-flat">Send</button>
                        </span>
                    {{ room_name|json_script:"room-name" }}
                  </div>
                <!-- </form> -->
              </div>
              <!-- /.box-footer-->
            </div>
            {{ request.user.id|json_script:"user_id" }}
            <!--/.direct-chat -->
          </div>
        </div>
        <div class="col-md-1">
        </div>
    </section>
    <!-- /.content -->
  </div>
{% endblock %}
{% block js %} 
    <script>
        var currentdate = new Date();
        // document.querySelector('#room-name-submit').onclick = function(e) {
        //     // var roomName = document.querySelector('#room-name-submit').value;
        //     // window.location.pathname = '/chatapp/' + roomName + '/';
        //     window.location.pathname = '/chatapp/admin/';
        // };

        const roomName = JSON.parse(document.getElementById('room-name').textContent);

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            console.log("to-user",roomName);
            console.log("message send")
            const data = JSON.parse(e.data);
            console.log(data);
            const from_user_id = data['user_id']
            const from_user = data['from_user']
            console.log("from_user_id",from_user_id);
            const loggedInUserId = JSON.parse(document.getElementById('user_id').textContent)
            console.log("login_user_id",loggedInUserId)
            if ( from_user_id == loggedInUserId) {
                // const right_div = document.getElementById("right-div");
                const chat_box = document.getElementById("chat-box");
                const right_div = document.createElement('div');
                right_div.classList.add('direct-chat-msg', 'right');
                const chat_div = document.createElement('div');
                chat_div.classList.add('direct-chat-info', 'clearfix');
                const chat_span = document.createElement('span');
                chat_span.classList.add('direct-chat-name', 'pull-right');
                chat_span.textContent = from_user;
                const time_span = document.createElement('span');
                time_span.classList.add('direct-chat-timestamp', 'pull-left');
                time_span.textContent = currentdate;
                chat_div.append(chat_span);
                chat_div.append(time_span);
                const msg_div = document.createElement('div');
                msg_div.classList.add('direct-chat-text');
                msg_div.innerHTML = data.message;
                right_div.append(chat_div)
                right_div.append(msg_div)
                chat_box.append(right_div)
                
            } 
            if ( from_user_id != loggedInUserId) {
                // const right_div = document.getElementById("left-div");
                const chat_box = document.getElementById("chat-box");
                const right_div = document.createElement('div');
                right_div.classList.add('direct-chat-msg');
                const chat_div = document.createElement('div');
                chat_div.classList.add('direct-chat-info', 'clearfix');
                const chat_span = document.createElement('span');
                chat_span.classList.add('direct-chat-name', 'pull-left');
                chat_span.textContent = from_user;
                const time_span = document.createElement('span');
                time_span.classList.add('direct-chat-timestamp', 'pull-right');
                time_span.textContent = currentdate;
                chat_div.append(chat_span);
                chat_div.append(time_span);
                const msg_div = document.createElement('div');
                msg_div.classList.add('direct-chat-text');
                msg_div.innerHTML = data.message;
                right_div.append(chat_div)
                right_div.append(msg_div)
                chat_box.append(right_div)

            }
            
            // document.querySelector('#chat-log').value += (data.message + '\n');
        };

        chatSocket.onclose = function(e) {
            console.log(e);
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>
{% endblock %}